name: Sync DATASUS SIASUS

on:
  schedule:
    - cron: '0 9 * * *'  # Diariamente √†s 9h UTC (6h BRT)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Install lftp
        run: sudo apt-get install -y lftp
        
      - name: Download BPA files (√∫ltimos 6 meses)
        run: |
          mkdir -p bpa
          cd bpa
          
          lftp -c "
          set ftp:ssl-allow no;
          open ftp://anonymous:@ftp.datasus.gov.br;
          cd /siasus/BPA;
          cls -1 BPAMAG*.exe > /tmp/bpa_arquivos.txt
          "
          
          tail -n 6 /tmp/bpa_arquivos.txt > /tmp/bpa_ultimos6.txt
          
          echo "üì• Arquivos BPA a serem baixados:"
          cat /tmp/bpa_ultimos6.txt
          
          while IFS= read -r arquivo; do
            if [ ! -f "$arquivo" ]; then
              echo "‚¨áÔ∏è  Baixando: $arquivo"
              lftp -c "
              set ftp:ssl-allow no;
              open ftp://anonymous:@ftp.datasus.gov.br;
              cd /siasus/BPA;
              get -c \"$arquivo\"
              "
            else
              echo "‚úÖ J√° existe: $arquivo"
            fi
          done < /tmp/bpa_ultimos6.txt
          
          # Baixa documenta√ß√£o
          if [ ! -f "BPA_LEIAME.txt" ]; then
            lftp -c "
            set ftp:ssl-allow no;
            open ftp://anonymous:@ftp.datasus.gov.br;
            cd /siasus/BPA;
            get -c BPA_LEIAME.txt
            " || echo "‚ö†Ô∏è  BPA_LEIAME.txt n√£o dispon√≠vel"
          fi
      
      - name: Download BDSIA files (√∫ltimos 6 meses)
        run: |
          mkdir -p bdsia
          cd bdsia
          
          lftp -c "
          set ftp:ssl-allow no;
          open ftp://anonymous:@ftp.datasus.gov.br;
          cd /siasus/bdsia;
          cls -1 BDSIA*.exe > /tmp/bdsia_arquivos.txt
          "
          
          tail -n 6 /tmp/bdsia_arquivos.txt > /tmp/bdsia_ultimos6.txt
          
          echo "üì• Arquivos BDSIA a serem baixados:"
          cat /tmp/bdsia_ultimos6.txt
          
          while IFS= read -r arquivo; do
            if [ ! -f "$arquivo" ]; then
              echo "‚¨áÔ∏è  Baixando: $arquivo"
              lftp -c "
              set ftp:ssl-allow no;
              open ftp://anonymous:@ftp.datasus.gov.br;
              cd /siasus/bdsia;
              get -c \"$arquivo\"
              "
            else
              echo "‚úÖ J√° existe: $arquivo"
            fi
          done < /tmp/bdsia_ultimos6.txt
          
          # Baixa documenta√ß√£o
          for doc in BDNOTAS.TXT LERNOTAS.TXT; do
            if [ ! -f "$doc" ]; then
              lftp -c "
              set ftp:ssl-allow no;
              open ftp://anonymous:@ftp.datasus.gov.br;
              cd /siasus/bdsia;
              get -c $doc
              " || echo "‚ö†Ô∏è  $doc n√£o dispon√≠vel"
            fi
          done
      
      - name: Clean old files
        run: |
          cd bpa
          for arquivo in BPAMAG*.exe; do
            if [ -f "$arquivo" ] && ! grep -q "$arquivo" /tmp/bpa_ultimos6.txt; then
              echo "üóëÔ∏è  Removendo BPA antigo: $arquivo"
              rm "$arquivo"
            fi
          done
          
          cd ../bdsia
          for arquivo in BDSIA*.exe; do
            if [ -f "$arquivo" ] && ! grep -q "$arquivo" /tmp/bdsia_ultimos6.txt; then
              echo "üóëÔ∏è  Removendo BDSIA antigo: $arquivo"
              rm "$arquivo"
            fi
          done
      
      - name: Generate file statistics
        run: |
          echo "BPA_SIZE=$(du -sh bpa | cut -f1)" >> $GITHUB_ENV
          echo "BDSIA_SIZE=$(du -sh bdsia | cut -f1)" >> $GITHUB_ENV
          echo "BPA_COUNT=$(ls -1 bpa/BPAMAG*.exe 2>/dev/null | wc -l)" >> $GITHUB_ENV
          echo "BDSIA_COUNT=$(ls -1 bdsia/BDSIA*.exe 2>/dev/null | wc -l)" >> $GITHUB_ENV
          echo "TOTAL_SIZE=$(du -sh . | cut -f1)" >> $GITHUB_ENV
      
      - name: Generate README with file list
        run: |
          cat > README.md << EOF
          # üìä DATASUS - SIASUS (SIA/BPA)
          
          [![Sync Status](https://github.com/${{ github.repository }}/actions/workflows/sync-datasus.yml/badge.svg)](https://github.com/${{ github.repository }}/actions/workflows/sync-datasus.yml)
          [![√öltima Atualiza√ß√£o](https://img.shields.io/badge/√∫ltima%20atualiza√ß√£o-$(date -u '+%Y--%m--%d')-blue)](https://github.com/${{ github.repository }}/commits/main)
          
          Reposit√≥rio automatizado com mirror dos arquivos do **Sistema de Informa√ß√µes Ambulatoriais do SUS (SIA)** do DATASUS, incluindo:
          - **BPA** - Boletim de Produ√ß√£o Ambulatorial
          - **BDSIA** - Base de Dados SIA (Tabelas Nacionais)
          
          ## üì¶ Arquivos BPA (√öltimos 6 Meses)
          
          > **Total:** $BPA_COUNT arquivos | **Tamanho:** $BPA_SIZE
          
          | Arquivo | Compet√™ncia | Tamanho | Download |
          |---------|-------------|---------|----------|
          EOF
          
          cd bpa
          for arquivo in $(ls -r BPAMAG*.exe 2>/dev/null); do
            # Extrai compet√™ncia (AAMM) do nome do arquivo
            comp=$(echo "$arquivo" | grep -oP '(?<=BPAMAG)\d{4}')
            ano="20${comp:0:2}"
            mes="${comp:2:2}"
            
            # Formata m√™s
            case $mes in
              01) mes_nome="Janeiro" ;;
              02) mes_nome="Fevereiro" ;;
              03) mes_nome="Mar√ßo" ;;
              04) mes_nome="Abril" ;;
              05) mes_nome="Maio" ;;
              06) mes_nome="Junho" ;;
              07) mes_nome="Julho" ;;
              08) mes_nome="Agosto" ;;
              09) mes_nome="Setembro" ;;
              10) mes_nome="Outubro" ;;
              11) mes_nome="Novembro" ;;
              12) mes_nome="Dezembro" ;;
            esac
            
            tamanho=$(ls -lh "$arquivo" | awk '{print $5}')
            url="https://github.com/${{ github.repository }}/raw/main/bpa/$arquivo"
            
            echo "| \`$arquivo\` | $mes_nome/$ano | $tamanho | [‚¨áÔ∏è Download]($url) |" >> ../README.md
          done
          cd ..
          
          cat >> README.md << EOF
          
          ## üóÉÔ∏è Arquivos BDSIA (√öltimos 6 Meses)
          
          > **Total:** $BDSIA_COUNT arquivos | **Tamanho:** $BDSIA_SIZE
          
          | Arquivo | Compet√™ncia | Tamanho | Download |
          |---------|-------------|---------|----------|
          EOF
          
          cd bdsia
          for arquivo in $(ls -r BDSIA*.exe 2>/dev/null); do
            # Extrai compet√™ncia (AAAAMM) do nome
            comp=$(echo "$arquivo" | grep -oP '(?<=BDSIA)\d{6}')
            ano="${comp:0:4}"
            mes="${comp:4:2}"
            versao=$(echo "$arquivo" | grep -oP '[a-z](?=\.exe)')
            
            case $mes in
              01) mes_nome="Janeiro" ;;
              02) mes_nome="Fevereiro" ;;
              03) mes_nome="Mar√ßo" ;;
              04) mes_nome="Abril" ;;
              05) mes_nome="Maio" ;;
              06) mes_nome="Junho" ;;
              07) mes_nome="Julho" ;;
              08) mes_nome="Agosto" ;;
              09) mes_nome="Setembro" ;;
              10) mes_nome="Outubro" ;;
              11) mes_nome="Novembro" ;;
              12) mes_nome="Dezembro" ;;
            esac
            
            tamanho=$(ls -lh "$arquivo" | awk '{print $5}')
            url="https://github.com/${{ github.repository }}/raw/main/bdsia/$arquivo"
            comp_label="$mes_nome/$ano"
            [ -n "$versao" ] && comp_label="$comp_label (rev. $versao)"
            
            echo "| \`$arquivo\` | $comp_label | $tamanho | [‚¨áÔ∏è Download]($url) |" >> ../README.md
          done
          cd ..
          
          cat >> README.md << 'EOF'
          
          ## üìñ Sobre os Arquivos
          
          ### BPA - Boletim de Produ√ß√£o Ambulatorial
          - Programa para processamento da produ√ß√£o ambulatorial
          - Registra procedimentos realizados em estabelecimentos de sa√∫de
          - Formato: arquivo execut√°vel auto-extra√≠vel (.exe)
          - Gera base de dados DBase ap√≥s instala√ß√£o
          
          ### BDSIA - Base de Dados SIA
          - Cont√©m as **tabelas nacionais** do Sistema de Informa√ß√µes Ambulatoriais
          - Inclui: procedimentos, CBO, CID-10, ocupa√ß√µes, financiamento
          - Atualizada mensalmente com novas portarias e altera√ß√µes
          - Essencial para valida√ß√£o e processamento do BPA
          
          ## üîÑ Atualiza√ß√£o Autom√°tica
          
          Este reposit√≥rio √© atualizado **diariamente √†s 6h (hor√°rio de Bras√≠lia)** via GitHub Actions.
          
          **Fontes oficiais:**
          - BPA: [ftp://ftp.datasus.gov.br/siasus/BPA](ftp://ftp.datasus.gov.br/siasus/BPA)
          - BDSIA: [ftp://ftp.datasus.gov.br/siasus/bdsia](ftp://ftp.datasus.gov.br/siasus/bdsia)
          
          ## üíª Como Usar
          
          ### Download via wget/curl
          ```bash
          # √öltima vers√£o do BPA
          wget https://github.com/${{ github.repository }}/raw/main/bpa/BPAMAG2601.exe
          
          # √öltima vers√£o do BDSIA
          wget https://github.com/${{ github.repository }}/raw/main/bdsia/BDSIA202601a.exe
          ```
          
          ### Clone do reposit√≥rio
          ```bash
          git clone https://github.com/${{ github.repository }}.git
          cd SIASUS
          ```
          
          ### GitHub API (program√°tico)
          ```bash
          # Listar todos os arquivos BPA
          curl -s https://api.github.com/repos/${{ github.repository }}/contents/bpa | jq -r '.[].download_url'
          
          # Listar todos os arquivos BDSIA
          curl -s https://api.github.com/repos/${{ github.repository }}/contents/bdsia | jq -r '.[].download_url'
          ```
          
          ### Instala√ß√£o no Windows
          ```cmd
          # Execute os arquivos .exe para instalar
          BPAMAG2601.exe
          BDSIA202601a.exe
          ```
          
          ## üìä Estrutura dos Arquivos
          
          ```
          SIASUS/
          ‚îú‚îÄ‚îÄ bpa/                        # BPA Magn√©tico (6 mais recentes)
          ‚îÇ   ‚îú‚îÄ‚îÄ BPAMAG*.exe
          ‚îÇ   ‚îî‚îÄ‚îÄ BPA_LEIAME.txt
          ‚îî‚îÄ‚îÄ bdsia/                      # Base de Dados SIA (6 mais recentes)
              ‚îú‚îÄ‚îÄ BDSIA*.exe
              ‚îú‚îÄ‚îÄ BDNOTAS.TXT
              ‚îî‚îÄ‚îÄ LERNOTAS.TXT
          ```
          
          ## üìù Formato dos Arquivos
          
          ### Nomenclatura BPA
          - **BPAMAG**AAMM**.exe** (ex: BPAMAG2601.exe)
            - AA = Ano (26 = 2026)
            - MM = M√™s (01 = Janeiro)
          
          ### Nomenclatura BDSIA
          - **BDSIA**AAAAMM**x.exe** (ex: BDSIA202601a.exe)
            - AAAA = Ano completo (2026)
            - MM = M√™s (01 = Janeiro)
            - x = Revis√£o (a, b, c, d...)
          
          ## üîó Reposit√≥rios Relacionados
          
          - [SIGTAP](https://github.com/${{ github.repository_owner }}/SIGTAP) - Tabela Unificada de Procedimentos
          
          ## ‚öñÔ∏è Licen√ßa e Dados P√∫blicos
          
          Os dados s√£o de **dom√≠nio p√∫blico** e mantidos pelo Minist√©rio da Sa√∫de do Brasil.
          Este reposit√≥rio apenas facilita o acesso aos arquivos oficiais.
          
          ---
          
          <div align="center">
          
          **ü§ñ Atualizado automaticamente** | √öltima execu√ß√£o: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          üì¶ Tamanho total: $TOTAL_SIZE
          
          </div>
          EOF
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git fetch origin main
          git reset --soft origin/main
          
          git add -A
          
          if ! git diff --staged --quiet; then
            CHANGES=$(git diff --staged --name-status | head -10)
            
            git commit -m "üîÑ Atualiza√ß√£o autom√°tica SIASUS - $(date -u '+%Y-%m-%d %H:%M')" \
                       -m "Altera√ß√µes:" \
                       -m "$CHANGES"
            
            for i in {1..3}; do
              if git push origin HEAD:main; then
                echo "‚úÖ Altera√ß√µes enviadas com sucesso"
                break
              else
                echo "‚ö†Ô∏è  Tentativa $i falhou, sincronizando..."
                git fetch origin main
                git rebase origin/main
                sleep 2
              fi
            done
          else
            echo "‚ÑπÔ∏è  Nenhuma altera√ß√£o detectada"
          fi
